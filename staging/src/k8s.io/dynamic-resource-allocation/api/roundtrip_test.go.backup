package api_test

import (
	"math/rand"
	"testing"
	"time"

	"k8s.io/apimachinery/pkg/api/apitesting/fuzzer"
	"k8s.io/apimachinery/pkg/api/apitesting/roundtrip"
	metafuzzer "k8s.io/apimachinery/pkg/apis/meta/fuzzer"
	"k8s.io/apimachinery/pkg/runtime"
	"k8s.io/apimachinery/pkg/runtime/schema"
	"k8s.io/apimachinery/pkg/runtime/serializer"

	// Core Kubernetes resource API types
	resourcev1 "k8s.io/api/resource/v1"
	resourcev1beta1 "k8s.io/api/resource/v1beta1"
	resourcev1beta2 "k8s.io/api/resource/v1beta2"
)

func TestDynamicResourceAllocationRoundTripFuzz(t *testing.T) {
	scheme := runtime.NewScheme()

	// Register the resource.k8s.io API types
	// v1 is the hub version, so it's registered first.
	if err := resourcev1.AddToScheme(scheme); err != nil {
		t.Fatalf("failed to add resource/v1 to scheme: %v", err)
	}
	if err := resourcev1beta1.AddToScheme(scheme); err != nil {
		t.Fatalf("failed to add resource/v1beta1 to scheme: %v", err)
	}
	if err := resourcev1beta2.AddToScheme(scheme); err != nil {
		t.Fatalf("failed to add resource/v1beta2 to scheme: %v", err)
	}

	codecs := serializer.NewCodecFactory(scheme)

	seed := time.Now().UnixNano()
	t.Logf("Fuzz seed: %d", seed)

	f := fuzzer.FuzzerFor(metafuzzer.Funcs, rand.NewSource(seed), codecs)

	// Define the DRA types from the resource.k8s.io API group
	kinds := map[schema.GroupVersionKind]bool{
		// DRA types in the v1 API
		{Group: "resource.k8s.io", Version: "v1", Kind: "ResourceClaim"}:         true,
		{Group: "resource.k8s.io", Version: "v1", Kind: "ResourceClaimTemplate"}: true,
		{Group: "resource.k8s.io", Version: "v1", Kind: "ResourceClass"}:         true,
		{Group: "resource.k8s.io", Version: "v1", Kind: "ResourceSlice"}:         true,

		// DRA types in the v1beta2 API (used from v1.33 onward)[citation:5]
		{Group: "resource.k8s.io", Version: "v1beta2", Kind: "ResourceClaim"}:         true,
		{Group: "resource.k8s.io", Version: "v1beta2", Kind: "ResourceClaimTemplate"}: true,
		{Group: "resource.k8s.io", Version: "v1beta2", Kind: "ResourceClass"}:         true,
		{Group: "resource.k8s.io", Version: "v1beta2", Kind: "ResourceSlice"}:         true,

		// DRA types in the v1beta1 API
		{Group: "resource.k8s.io", Version: "v1beta1", Kind: "ResourceClaim"}:         true,
		{Group: "resource.k8s.io", Version: "v1beta1", Kind: "ResourceClaimTemplate"}: true,
		{Group: "resource.k8s.io", Version: "v1beta1", Kind: "ResourceClass"}:         true,
		{Group: "resource.k8s.io", Version: "v1beta1", Kind: "ResourceSlice"}:         true,
	}

	roundtrip.RoundTripTypes(t, scheme, codecs, f, kinds)
}
